import{r as a,a as O,j as e,u as ae}from"./index-Bluomjo3.js";import{B as le,u as re}from"./BaseSocketService-Bl9hlbK-.js";import{D as R,a as q}from"./Dialog-Bf6WNdOJ.js";import{D as W,a as K,T as ne,H as oe}from"./TableDisplay-DKLLAhU6.js";import{c as V}from"./createLucideIcon-BSuAhcd7.js";import{I as ce}from"./info-Bp7fWxG0.js";import{S as ie,a as de}from"./SearchDisplay-Hgc5dbHY.js";import{B as me}from"./Breadcrumb-C_-aqw1f.js";import{P as J}from"./Pagination-D6bEGNZS.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],Q=V("TriangleAlert",ue);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=[["path",{d:"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",key:"cbrjhi"}]],xe=V("Wrench",he);class ge extends le{constructor(){super("api/camera")}}const fe=new ge,F={page:1,limit:10,camera_id:null,floor:null,zone:null,status:null},pe=()=>{const t=re(fe,!0),[n,i]=a.useState(!1),[g,c]=a.useState(!0),[m,u]=a.useState(null),[f,r]=a.useState(!1),[j,y]=a.useState(!1),[b,p]=a.useState(null),[w,h]=a.useState({data:[],meta:{lastPage:0,total:0,page:1,limit:10}}),[P,N]=a.useState({data:[],meta:{total:0,totalPages:0,page:1,limit:10}}),{user:k}=O(),[$,D]=a.useState("all"),[T,A]=a.useState(new Date),[E,v]=a.useState(null),[z,H]=a.useState(!1),[I,L]=a.useState(!1),[C,M]=a.useState(F),l=a.useCallback(s=>{s.updatedCamera?N(o=>({...o,data:o.data.map(x=>x.camera_id===s.updatedCamera.camera_id?s.updatedCamera:x)})):Array.isArray(s.data)&&N(s),A(new Date)},[]);a.useEffect(()=>{if(!t)return;const s=()=>{console.log("Socket connected successfully"),i(!0)},o=()=>{console.log("Socket disconnected"),i(!1),u("การเชื่อมต่อขัดข้อง กำลังพยายามเชื่อมต่อใหม่...")};return t.on("connect",s),t.on("disconnect",o),t.on("camerasUpdated",l),t.connected&&i(!0),()=>{t.off("connect",s),t.off("disconnect",o),t.off("camerasUpdated",l)}},[t]),a.useEffect(()=>{n&&(console.log("Connection established, fetching initial data..."),_())},[n]);const _=a.useCallback(async()=>{if(!(t!=null&&t.connected)||!n){console.log("Cannot fetch: Socket not ready",{socketExists:!!t,socketConnected:t==null?void 0:t.connected,isConnected:n}),u("รอการเชื่อมต่อ...");return}console.log("Fetching cameras with filters:",C),c(!0);try{t.emit("getPage",C,s=>{console.log("Received camera data:",s),s.success?(N(s.data),A(new Date),u(null)):(console.error("Failed to fetch cameras:",s.error),u(s.error||"ไม่สามารถโหลดข้อมูลได้")),c(!1)})}catch(s){console.error("Error emitting getPage:",s),u("เกิดข้อผิดพลาดในการโหลดข้อมูล"),c(!1)}},[t,n,C]),B=a.useCallback(s=>{const o=Object.values(s).some(d=>d!=null&&d!=="");r(o);const x=Object.entries(s).reduce((d,[S,G])=>(G===void 0?d[S]=null:G instanceof Date?d[S]=G.toISOString():d[S]=G,d),{});M(d=>({...d,...x,page:1}))},[]),X=a.useCallback(()=>{r(!1),M(F),D("all")},[]),Y=a.useCallback(s=>{D(s);const o={all:null,active:"ปกติ",waiting:"รอดำเนินการ",broken:"ชำรุด"};M(x=>({...x,status:o[s]||null,page:1}))},[]),Z=a.useCallback(s=>{M(o=>({...o,page:s}))},[]),ee=a.useCallback(s=>{const o={id:s.camera_id,status:s.status,userId:k==null?void 0:k.username,note:s.note||"Status updated"};if(!t||!n){u("รอการเชื่อมต่อ...");return}t.emit("updateStatus",o,x=>{x.success?N(d=>({...d,data:d.data.map(S=>S.camera_id===s.camera_id?{...S,status:s.status}:S)})):u(x.error||"ไม่สามารถอัพเดตสถานะได้")})},[t,n,k]),U=a.useCallback(async(s,o=1,x=10)=>{if(!t||!n){p("รอการเชื่อมต่อ...");return}y(!0),t.emit("getHistory",{cameraId:s,page:o,limit:x},d=>{d.success?(h(d.data),p(null)):p(d.error||"ไม่สามารถโหลดประวัติได้"),y(!1)})},[t,n]);a.useEffect(()=>{if(!t)return;const s=o=>{o.message==="Unauthorized"||o.message==="Invalid token"?p("กรุณาเข้าสู่ระบบใหม่"):p(o.message||"เกิดข้อผิดพลาดในการโหลดประวัติ"),y(!1)};return t.on("historyError",s),()=>{t.off("historyError",s)}},[t]);const te=a.useCallback((s,o)=>{v(o),s==="history"?(H(!0),U(o.camera_id)):L(!0)},[U]),se=a.useCallback(()=>{H(!1),L(!1),v(null)},[]);return a.useEffect(()=>{n&&_()},[C,n,_]),{loading:g,isConnected:n,error:m,cameras:P,filters:C,activeTab:$,lastRefreshTime:T,selectedCamera:E,showHistoryModal:z,showMaintenanceModal:I,historyLoading:j,historyError:b,history:w,isSearch:f,handleSearch:B,handlePageChange:Z,handleClear:X,handleTabChange:Y,handleStatusUpdate:ee,handleModalControl:te,closeModals:se,fetchCamerasData:_,getHistory:U,setSelectedCamera:v}},ye={ปกติ:"bg-green-100 text-green-800",ชำรุด:"bg-red-100 text-red-800",รอดำเนินการ:"bg-yellow-100 text-yellow-800",ไม่ได้ใช้งาน:"bg-gray-100 text-gray-800"},be=[{header:"แผนผัง",key:"zone",placeholder:"เลือกแผนผัง",type:"select",options:[{label:"แผนผัง A",value:"A"},{label:"แผนผัง B",value:"B"}]},{header:"ชั้น",key:"floor",placeholder:"เลือกชั้น",type:"select",options:[{label:"ชั้น 01",value:"01"},{label:"ชั้น 02",value:"02"}]}],je=({isOpen:t,onClose:n,camera:i,onSubmit:g})=>{const[c,m]=a.useState(""),[u,f]=a.useState(!1),[r,j]=a.useState(""),[y,b]=a.useState(""),p=async h=>{if(h.preventDefault(),r.trim().toLowerCase()!=="ยืนยัน"){b('กรุณาพิมพ์ "ยืนยัน" เพื่อยืนยันการแจ้งซ่อม');return}try{f(!0),b(""),g(i,"รอดำเนินการ",c),j(""),m(""),n()}catch(P){console.error("Error submitting maintenance request:",P),b("เกิดข้อผิดพลาดในการส่งคำร้อง กรุณาลองอีกครั้ง")}finally{f(!1)}},w=()=>{j(""),m(""),b(""),n()};return e.jsx(R,{open:t,onOpenChange:w,children:e.jsxs(q,{className:"sm:max-w-[500px]",children:[e.jsx(W,{children:e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"h-6 w-6 text-red-500"}),"แจ้งซ่อมกล้อง ",i.camera_id]})}),e.jsxs("form",{onSubmit:p,className:"space-y-4 p-4",children:[e.jsxs("div",{className:"bg-yellow-50 border-l-4 border-yellow-400 p-3 flex items-start gap-2",children:[e.jsx(ce,{className:"h-5 w-5 text-yellow-600 mt-1"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-yellow-800",children:["ตำแหน่งกล้อง: ชั้น ",i.floor," ลานจอด ",i.zone," ช่องจอด ",i.slot,"-",i.spot]}),e.jsxs("p",{className:"text-sm text-yellow-800",children:["สถานะปัจจุบัน: ",i.status]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"หมายเหตุเพิ่มเติม (ถ้ามี)"}),e.jsx("textarea",{value:c,onChange:h=>m(h.target.value),className:"w-full rounded-md border p-2 min-h-[100px]",placeholder:"กรอกรายละเอียดปัญหาที่พบ (ถ้ามี)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:'กรุณาพิมพ์ "ยืนยัน" เพื่อติดต่อเจ้าหน้าที่'}),e.jsx("input",{type:"text",required:!0,placeholder:"ระบุ ยืนยัน",className:`mt-1 block w-full rounded-md border p-2 ${y?"border-red-500":""}`,value:r,onChange:h=>{j(h.target.value),b("")},onKeyDown:h=>{h.key===" "&&h.preventDefault()}}),y&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:y})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx("button",{type:"button",onClick:w,className:"px-4 py-2 border rounded-md hover:bg-gray-50",children:"ยกเลิก"}),e.jsx("button",{type:"submit",disabled:r.trim().toLowerCase()!=="ยืนยัน"||u,className:`px-4 py-2 rounded-md text-white transition-colors ${r.trim().toLowerCase()==="ยืนยัน"&&!u?"bg-red-600 hover:bg-red-700":"bg-gray-400 cursor-not-allowed"}`,children:u?"กำลังส่ง...":"แจ้งซ่อม"})]})]})]})})},Ne=({variant:t="default",className:n="",children:i,...g})=>{const c="relative w-full rounded border p-4",m={default:"bg-gray-50 text-gray-900 border-gray-200",destructive:"bg-red-50 text-red-900 border-red-200"};return e.jsx("div",{role:"alert",className:`${c} ${m[t]} ${n}`,...g,children:e.jsxs("div",{className:"flex items-center justify-between",children:[i,t==="destructive"&&e.jsx(Q,{className:" h-4 w-4 text-red-600"})]})})},ve=({children:t,...n})=>e.jsx("div",{className:"text-sm leading-6",...n,children:t}),Ce=({camera:t,isOpen:n,onClose:i,loading:g,history:c,onPageChange:m})=>{const u=r=>{switch(r){case"ปกติ":return"text-green-600";case"ชำรุด":return"text-red-600";case"รอดำเนินการ":return"text-yellow-600";default:return"text-gray-600"}},f=r=>{switch(r){case"CREATE":return"สร้าง";case"UPDATE_STATUS":return"อัพเดทสถานะ";default:return r}};return n?e.jsx(R,{open:n,onOpenChange:i,children:e.jsxs(q,{className:"max-w-lg",children:[e.jsxs(W,{children:[e.jsx("button",{onClick:i,className:"absolute top-3 right-3 text-gray-600 hover:text-gray-900",children:"✕"}),e.jsxs(K,{className:"text-header",children:["ประวัติกล้อง ",t.camera_id]})]}),e.jsx("div",{className:"space-y-4 h-96 overflow-y-auto p-4",children:c.data.map(r=>e.jsxs("div",{className:"border rounded-lg p-4 bg-white shadow",children:[e.jsx("div",{className:"flex justify-between",children:e.jsxs("span",{className:"text-sm text-mediumGray",children:["วันที่ ",new Date(r.timestamp).toLocaleString("en-GB")]})}),e.jsxs("div",{className:"text-sm mt-2",children:[e.jsx("strong",{className:"text-header",children:"ตำแหน่ง:"})," ",e.jsxs("p",{className:"text-mediumGray",children:["ลานจอด ",t.zone," ชั้น ",t.floor," แถว ",t.slot," ช่อง ",t.spot]})]}),e.jsxs("div",{className:"text-sm mt-2",children:[e.jsx("strong",{className:"text-header",children:"การดำเนินการ:"})," ",e.jsx("span",{className:"text-mediumGray",children:f(r.action)}),r.oldStatus&&r.newStatus&&e.jsxs("span",{children:[e.jsx("strong",{className:"text-mediumGray",children:" → "}),e.jsx("span",{className:"text-mediumGray",children:"จาก"})," ",e.jsx("span",{className:u(r.oldStatus),children:r.oldStatus})," ",e.jsx("span",{className:"text-mediumGray",children:"เป็น"})," ",e.jsx("span",{className:u(r.newStatus),children:r.newStatus})]})]}),r.changed_by&&e.jsxs("div",{className:"text-sm mt-2",children:[e.jsx("strong",{className:"text-header",children:"ดำเนินการโดย:"})," ",e.jsx("p",{className:"text-mediumGray",children:r.changed_by})]}),r.note&&e.jsxs("div",{className:"text-sm mt-2",children:[e.jsx("strong",{className:"text-header",children:"หมายเหตุ:"})," ",e.jsx("p",{className:"text-mediumGray",children:r.note})]})]},r.camera_history_id))}),!g&&c.meta.lastPage>1&&e.jsx("div",{className:"mt-4 border-t pt-4",children:e.jsx(J,{currentPage:c.meta.page,totalPages:c.meta.lastPage,onPageChange:m,totalItems:c.meta.total,itemsPerPage:c.meta.limit})})]})}):null},Ae=()=>{const t=ae(),{isAuthenticated:n,isLoading:i}=O(),{error:g,cameras:c,filters:m,activeTab:u,selectedCamera:f,showHistoryModal:r,showMaintenanceModal:j,handleSearch:y,handlePageChange:b,handleClear:p,handleTabChange:w,handleStatusUpdate:h,handleModalControl:P,closeModals:N,historyLoading:k,historyError:$,history:D,isSearch:T,getHistory:A}=pe();a.useEffect(()=>{!n&&!i&&t("/")},[n,i,t]);const[E,v]=a.useState(null),z={camera_id:m.camera_id,floor:m.floor,zone:m.zone,status:m.status},H=(l,_,B)=>{h({camera_id:l.camera_id,status:_,note:B}),v(null)},I=[{key:"camera_id",label:"รหัสกล้อง",render:l=>e.jsx("p",{className:"whitespace-nowrap text-sm",children:l.camera_id})},{key:"location",label:"ตำแหน่ง",render:l=>l.floor?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm",children:["ชั้น ",l.floor]}),e.jsxs("div",{className:"text-xs text-mediumGray",children:["ลานจอด ",l.zone,", ช่องจอด ",l.slot,"-",l.spot]})]}):e.jsx("div",{className:"text-sm text-mediumGray",children:"ไม่มีตำแหน่ง"})},{key:"status",label:"สถานะ",render:l=>e.jsx("span",{className:`px-3 py-1 rounded-full text-sm ${ye[l.status]}`,children:l.status})},{key:"lastStatusChange",label:"อัปเดตล่าสุด",render:l=>new Date(l.lastStatusChange).toLocaleString("en-GB")}],L=l=>e.jsxs("div",{className:"flex gap-2 justify-center items-center",children:[e.jsx("button",{onClick:()=>P("history",l),className:"text-header hover:text-gray-900",title:"ดูประวัติ",children:e.jsx(oe,{className:"h-5 w-5"})}),l.status==="ชำรุด"&&e.jsx("button",{onClick:()=>v(l),className:"text-error hover:text-red-900",title:"แจ้งซ่อม",children:e.jsx(xe,{className:"h-5 w-5"})})]}),C=l=>`
    hover:bg-gray-50 transition-colors 
    ${l.status==="ชำรุด"?"bg-red-50":""}
  `,M=()=>T?e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:" text-mediumGray mb-2 flex items-start gap-2 justify-center w-full",children:[e.jsx(de,{className:"w-5 h-5"}),"  ไม่พบข้อมูลที่ค้นหา"]}),e.jsxs("div",{className:"text-sm text-gray-400",children:["กรุณาลองค้นหาด้วยเงื่อนไขอื่น หรือ",e.jsx("button",{onClick:p,className:"text-primary hover:underline ml-1",children:"ล้างการค้นหา"})]})]}):"ไม่พบข้อมูล";return e.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[e.jsx(me,{pageName:"ระบบจัดการกล้องวงจรปิด"}),e.jsx("div",{className:"bg-white p-2 rounded w-fit",children:e.jsx("div",{className:"flex gap-4",children:[{key:"all",label:"ทั้งหมด",activeClass:"bg-primary text-secondary hover:bg-primaryContrast"},{key:"active",label:"ปกติ",activeClass:"bg-primary text-secondary hover:bg-primaryContrast"},{key:"waiting",label:"รอดำเนินการ",activeClass:"bg-primary text-secondary hover:bg-primaryContrast"},{key:"broken",label:"กล้องชำรุด",activeClass:"bg-primary text-secondary hover:bg-primaryContrast"}].map(l=>e.jsx("button",{onClick:()=>w(l.key),className:`px-4 py-2 rounded flex items-center gap-2 ${u===l.key?l.activeClass:" text-header hover:bg-secondary"}`,children:l.label},l.key))})}),e.jsxs("div",{className:"bg-white rounded",children:[e.jsx(ie,{searchConfig:be,onSearch:y,onClear:p,filters:z}),g&&e.jsx(Ne,{variant:"destructive",children:e.jsx(ve,{children:g})}),e.jsxs("div",{className:"px-4 pb-4",children:[e.jsx("div",{className:"flex justify-between items-center pb-4",children:e.jsx("div",{className:"text-header",children:T?`ผลการค้นหา (${c.meta.total})`:`จำนวนทั้งหมด (${c.meta.total})`})}),e.jsx(ne,{headers:I,data:c.data,actions:L,rowClassName:C,emptyMessage:M(),maxHeight:"400px"})]})]}),e.jsx(J,{currentPage:Number(m.page)||1,totalPages:Number(c.meta.totalPages)||1,onPageChange:b,totalItems:Number(c.meta.total)||0,itemsPerPage:Number(m.limit)||10}),E&&e.jsx(je,{isOpen:!!E,onClose:()=>v(null),camera:E,onSubmit:H}),f&&e.jsxs(e.Fragment,{children:[r&&e.jsx(Ce,{camera:f,isOpen:r,onClose:N,loading:k,error:$,history:D,onPageChange:l=>A(f.camera_id,l)}),j&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center",children:e.jsxs("div",{className:"bg-white p-6 rounded",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"แจ้งซ่อมกล้อง"}),e.jsx("p",{children:"รายละเอียดการแจ้งซ่อม..."}),e.jsx("button",{onClick:N,className:"mt-4 px-4 py-2 bg-blue-500 text-white rounded",children:"ปิด"})]})})]})]})};export{Ae as default};
